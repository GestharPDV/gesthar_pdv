{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="pr-15 pl-15">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="titulo">{{ page_title|upper }}</h1>
    <div class="d-flex gap-2 align-items-center">
      <a href="{% url 'product:product-update' product.pk %}" class="botao-amarelo p-2 text-decoration-none">Editar Produto</a>
      <form action="{% url 'product:product-delete' product.pk %}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir o produto {{ product.name }}?');">
        {% csrf_token %}
        <button type="submit" class="botao-vermelho p-2">Excluir Produto</button>
      </form>
      <a href="{% url 'product:product-list' %}" class="botao-rosa p-2 text-decoration-none">Voltar</a>
    </div>
  </div>

  <!-- Informações Gerais e Financeiras -->
  <div class="border border-separator rounded mb-4">
    <h2 class="subtitulo mb-0">Informações Gerais e Financeiras</h2>
    <div class="p-3">

      <div class="row mb-3">
        <div class="col-md-4 mb-3">
          <small class="d-block">PRODUTO</small>
          <p class="fs-5 fw-semibold">{{ product.name }}</p>
        </div>
        <div class="col-md-4 mb-3">
          <small class="d-block">CATEGORIA</small>
          <p class="fs-5 fw-semibold">{{ product.category.name }}</p>
        </div>
        <div class="col-md-4 mb-3">
          <small class="d-block">STATUS DO PRODUTO</small>
          {% if product.is_active %}
          <span class="fs-5 fw-semibold text-success">Ativo</span>
          {% else %}
          <span class="fs-5 fw-semibold text-danger">Inativo</span>
          {% endif %}
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="col-md-3 mb-3">
          <small class="d-block">PREÇO DE VENDA</small>
          <p class="fs-5 fw-bold">R$ {{ product.selling_price|floatformat:2 }}</p>
        </div>
        <div class="col-md-3 mb-3">
          <small class="d-block">CUSTO MÉDIO</small>
          <p class="fs-5 fw-semibold">R$ {{ product.average_cost_price|floatformat:2 }}</p>
        </div>
        <div class="col-md-3 mb-3">
          <small class="d-block">LUCRO (R$)</small>
          <p class="fs-5 fw-semibold text-lucro">R$ {{ profit_value|floatformat:2 }}</p>
        </div>
        <div class="col-md-3 mb-3">
          <small class="d-block">MARGEM DE LUCRO (%)</small>
          <p class="fs-5 fw-semibold text-success">{{ product.profit_margin|floatformat:2 }}%</p>
        </div>
      </div>

      {% if product.description %}
      <hr>
      <div>
        <small class="d-block">DESCRIÇÃO</small>
        <p class="fw-semibold">{{ product.description|linebreaks }}</p>
      </div>
      {% endif %}
    </div>
  </div>

  {# Fornecedores removidos daqui: iremos exibir o fornecedor nas variações #}

  <!-- Variações do Produto -->
  <div class="border border-separator rounded mb-4">
    <h2 class="subtitulo mb-0">Variações do Produto</h2>

    <div class="p-3 table-responsive">
      <table class="table table-bordered align-middle text-center mb-0">
        <thead class="cabecalho text-uppercase">
          <tr>
            <th scope="col">SKU</th>
            <th scope="col">Cor</th>
            <th scope="col">Tamanho</th>
            <th scope="col">Fornecedor</th>
            <th scope="col">Estoque Atual</th>
            <th scope="col">Estoque Mínimo</th>
            <th scope="col">Status da Variação</th>
          </tr>
        </thead>
        <tbody>
          {% for var in variations %}
          <tr class="{% if var.stock <= var.minimum_stock and var.is_active and var.stock > 0 %}table-warning fw-bold{% endif %}
                     {% if var.stock == 0 and var.is_active %}table-danger fw-bold{% endif %}">
            <td class="text-monospace">{{ var.sku }}</td>
            <td>{{ var.color.name }}</td>
            <td>{{ var.size.name }}</td>
            <td>
              {% if primary_supplier %}
              {{ primary_supplier.supplier.name }}
              {% else %}
              -
              {% endif %}
            </td>
            <td>{{ var.stock }}</td>
            <td>{{ var.minimum_stock }}</td>
            <td>
              {% if var.is_active %}
              <span class="text-success fw-semibold">Ativo</span>
              {% else %}
              <span class="text-danger fw-semibold">Inativo</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-muted">Nenhuma variação encontrada para este produto.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}