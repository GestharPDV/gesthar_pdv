{% extends 'base/base.html' %}
{% load static %}

{% block content %}
<div class="pr-15 pl-15">
  <h1 class="titulo">{{ page_title|upper }}</h1>

  {% comment %}Bloco para exibir erros gerais do formulário (ex: validações do clean){% endcomment %}
  {% if product_form.non_field_errors or supplier_formset.non_field_errors or variation_formset.non_field_errors %}
  <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
    <strong>Ocorreram erros ao salvar:</strong>
    <ul class="mb-0 mt-2">
      {% for error in product_form.non_field_errors %}
      <li>{{ error }}</li>
      {% endfor %}
      {% for error in supplier_formset.non_field_errors %}
      <li>{{ error }}</li>
      {% endfor %}
      {% for error in variation_formset.non_field_errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endif %}


  <form method="post" id="product-form" class="space-y-6">
    {% csrf_token %}

    <div class="border border-separator rounded mb-4">
      <h2 class="subtitulo mb-0">DADOS DO PRODUTO</h2>
      <div class="p-3">

        <div class="mb-3">
          <label for="{{ product_form.name.id_for_label }}" class="form-label fw-semibold mb-2 d-block">NOME</label>
          {{ product_form.name }}
          {% for error in product_form.name.errors %}
          <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="mb-3">
          <label for="{{ product_form.description.id_for_label }}" class="form-label fw-semibold mb-2 d-block">DESCRIÇÃO</label>
          {{ product_form.description }}
          {% for error in product_form.description.errors %}
          <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ product_form.selling_price.id_for_label }}" class="form-label fw-semibold mb-2 d-block">PREÇO DE VENDA</label>
            {{ product_form.selling_price }}
            {% for error in product_form.selling_price.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-6 mb-3">
            <label for="{{ product_form.category.id_for_label }}" class="form-label fw-semibold mb-2 d-block">CATEGORIA</label>
            <div class="d-flex gap-2 align-items-center">
              {{ product_form.category }}
              <button type="button" id="add-category-btn" class="p-2 botao-verde align-self-stretch" title="Adicionar nova categoria">+</button>
            </div>
            {% for error in product_form.category.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <div class="pt-2">
          <div class="form-check">
            {{ product_form.is_active }}
            <label class="form-check-label" for="{{ product_form.is_active.id_for_label }}">ATIVO</label>
          </div>
        </div>

      </div>
    </div>

    <div class="border border-separator rounded mb-4">
      <h2 class="subtitulo mb-0">FORNECEDORES E CUSTOS</h2>
      <div class="p-3">

        {{ supplier_formset.management_form }}

        <div id="supplier-form-list">
          {% for form in supplier_formset.forms %}
            <div class="row supplier-form-item mb-3">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold mb-2 d-block" for="{{ form.supplier.id_for_label }}">FORNECEDOR</label>
                <div class="d-flex gap-2 align-items-center">
                  {{ form.supplier }}
                  <button type="button" class="botao-verde p-2 add-supplier-btn align-self-stretch" title="Adicionar Fornecedor">+</button>
                </div>
                {% for error in form.supplier.errors %}
                <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold mb-2 d-block" for="{{ form.cost_price.id_for_label }}">PREÇO DE CUSTO</label>
                {{ form.cost_price }}
                {% for error in form.cost_price.errors %}
                <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              {{ form.id }}
            </div>
          {% endfor %}
        </div>

        <!-- template oculto para novo fornecedor -->
        <div id="empty-supplier-form" class="d-none">
          <div class="border rounded p-3 mb-3 position-relative supplier-form-item">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold mb-2 d-block">FORNECEDOR</label>
                <div class="d-flex gap-2 align-items-center">
                  <div class="flex-grow-1">{{ supplier_formset.empty_form.supplier }}</div>
                  <button type="button" class="botao-verde p-2 add-supplier-btn" title="Adicionar Fornecedor">+</button>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold mb-2 d-block">PREÇO DE CUSTO</label>
                {{ supplier_formset.empty_form.cost_price }}
              </div>
            </div>
            {{ supplier_formset.empty_form.id }}
          </div>
        </div>

        <!-- botão de adicionar fornecedor removido conforme solicitado -->

      </div>
    </div>


    <div id="variations-card" class="border border-separator rounded mb-4">
      <h2 class="subtitulo mb-0">VARIAÇÕES DO PRODUTO</h2>

      <div class="p-3">
        {{ variation_formset.management_form }}

        <div id="variation-form-list">
          {% for form in variation_formset.forms %}
          <div class="border rounded p-3 mb-3 variation-form">
            {{ form.id }}
            {% if form.non_field_errors %}
            <div class="alert alert-danger py-2 mb-3">
              <strong>Erro nesta variação:</strong>
              <ul class="mb-0 ms-3">
                {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
            <div class="row  align-items-start">
              <div class="col-md-2">
                <label class="form-label fw-semibold mb-2" for="{{ form.color.id_for_label }}">COR</label>
                <div class="d-flex gap-2 align-items-center">
                  {{ form.color }}
                  <button type="button" class="botao-verde p-2 add-color-btn align-self-stretch" title="Adicionar Cor">+</button>
                </div>
                {% for error in form.color.errors %}
                <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="col-md-2">
                <label class="form-label fw-semibold mb-2 " for="{{ form.size.id_for_label }}">TAMANHO</label>
                <div class="d-flex gap-2 align-items-center">
                  {{ form.size }}
                  <button type="button" class="botao-verde p-2 add-size-btn align-self-stretch" title="Adicionar Tamanho">+</button>
                </div>
                {% for error in form.size.errors %}
                <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="col-md-3">
                <label class="form-label fw-semibold mb-2 d-block" for="{{ form.stock.id_for_label }}">ESTOQUE</label>
                {{ form.stock }}
                {% for error in form.stock.errors %}
                <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="col-md-3">
                <label class="form-label fw-semibold mb-2 d-block" for="{{ form.minimum_stock.id_for_label }}">MÍNIMO</label>
                {{ form.minimum_stock }}
                {% for error in form.minimum_stock.errors %}
                <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="col-md-2 pt-4 d-flex flex-column align-items-center justify-content-center gap-2 position-relative">
                <div class="form-check align-items-center justify-content-center">
                  {{ form.is_active }}
                  <label class="form-check-label" for="{{ form.is_active.id_for_label }}">ATIVO</label>
                </div>
                <div class="d-none">{{ form.DELETE }}</div>
                <button type="button" class="btn-close position-absolute top-0 end-0 remove-variation-btn remove-form-btn" aria-label="Excluir" style="z-index:2;"></button>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <div id="empty-variation-form" class="d-none">
          <div class="border rounded p-3 mb-3 position-relative variation-form">
            {{ variation_formset.empty_form.id }}
            <div class="d-none">{{ variation_formset.empty_form.DELETE }}</div>

            <div class="row g-3">

              <div class="col-md-3">
                <label class="form-label fw-semibold mb-2 d-block">COR</label>
                <div class="d-flex gap-2 align-items-center">
                  <div class="flex-grow-1">{{ variation_formset.empty_form.color }}</div>
                  <button type="button" class="botao-verde p-2 add-color-btn" title="Adicionar Cor">+</button>
                </div>
              </div>

              <div class="col-md-3">
                <label class="form-label fw-semibold mb-2 d-block">TAMANHO</label>
                <div class="d-flex gap-2 align-items-center">
                  <div class="flex-grow-1">{{ variation_formset.empty_form.size }}</div>
                  <button type="button" class="botao-verde p-2 add-size-btn" title="Adicionar Tamanho">+</button>
                </div>
              </div>

              <div class="col-md-2">
                <label class="form-label fw-semibold mb-2 d-block">ESTOQUE</label>
                {{ variation_formset.empty_form.stock }}
              </div>

              <div class="col-md-2">
                <label class="form-label fw-semibold mb-2 d-block">ESTOQUE MÍNIMO</label>
                {{ variation_formset.empty_form.minimum_stock }}
              </div>

              <div class="col-md-2 d-flex flex-column align-items-center justify-content-center gap-2">
                <div class="form-check d-flex flex-column align-items-center justify-content-center">
                  {{ variation_formset.empty_form.is_active }}
                  <label class="form-check-label">Ativo</label>
                </div>

                <!-- botão de remover substituído por um 'x' posicionado no topo (consistente com fornecedores) -->
              </div>

            </div>
          </div>
        </div>

        <button type="button" id="add-variation-form" class="btn-warning botao-verde p-2 fw-bold">
          + Adicionar Variação
        </button>

      </div>
    </div>


    <div class="mt-4 d-flex gap-3">
      <button type="submit" class="botao-rosa p-3 fw-bold">{{ button_text|upper }}</button>

      <a href="{% url 'product:product-list' %}" class="botao-vermelho p-3 fw-bold">CANCELAR</a>
    </div>
  </form>

  <!-- CATEGORY MODAL -->
  <div id="category-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-4">
        <h3 class="fs-subtitulo fw-bold mb-3">Nova Categoria</h3>
        <form id="category-modal-form">
          <div class="mb-3">
            <label for="id_new_category_name" class="form-label">Nome</label>
            <input type="text" id="id_new_category_name" class="form-control" required />
            <p id="category-modal-error" class="text-danger small d-none mt-1"></p>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" id="cancel-category-btn" class="botao-vermelho p-2">Cancelar</button>
            <button type="submit" class="botao-verde p-2">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- SUPPLIER MODAL -->
  <div id="supplier-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-4">
        <h3 class="fs-subtitulo fw-bold mb-3">Novo Fornecedor</h3>
        <form id="supplier-modal-form">
          <div class="mb-3">
            <label for="id_new_supplier_name" class="form-label">Nome</label>
            <input type="text" id="id_new_supplier_name" class="form-control" required />
            <p id="supplier-modal-error" class="text-danger small d-none mt-1"></p>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" id="cancel-supplier-btn" class="botao-vermelho p-2">Cancelar</button>
            <button type="submit" class="botao-verde p-2">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- COLOR MODAL -->
  <div id="color-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-4">
        <h3 class="fs-subtitulo fw-bold mb-3">Nova Cor</h3>
        <form id="color-modal-form">
          <div class="mb-3">
            <label for="id_new_color_name" class="form-label">Nome</label>
            <input type="text" id="id_new_color_name" class="form-control" required />
            <p id="color-modal-error" class="text-danger small d-none mt-1"></p>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" id="cancel-color-btn" class="botao-vermelho p-2">Cancelar</button>
            <button type="submit" class="botao-verde p-2">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- SIZE MODAL -->
  <div id="size-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-4">
        <h3 class="fs-subtitulo fw-bold mb-3">Novo Tamanho</h3>
        <form id="size-modal-form">
          <div class="mb-3">
            <label for="id_new_size_name" class="form-label">Nome</label>
            <input type="text" id="id_new_size_name" class="form-control" required />
            <p id="size-modal-error" class="text-danger small d-none mt-1"></p>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" id="cancel-size-btn" class="botao-vermelho p-2">Cancelar</button>
            <button type="submit" class="botao-verde p-2">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ----------------------------------------
    // [ORIGINAL] Função utilitária para pegar o CSRF token
    // ----------------------------------------
    function getCsrfToken() {
      return document.querySelector('input[name="csrfmiddlewaretoken"]').value
    }

    // ----------------------------------------
    // [ORIGINAL] Lógica de adicionar formset
    // ----------------------------------------
    function setupAddFormButton(buttonId, listId, emptyFormId, prefix) {
      const addBtn = document.getElementById(buttonId)
      if (!addBtn) return

      addBtn.addEventListener('click', function () {
        const formList = document.getElementById(listId)
        const emptyFormTemplate = document.getElementById(emptyFormId).innerHTML
        const totalFormsInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`)

        let formNum = parseInt(totalFormsInput.value)
        let newFormHTML = emptyFormTemplate.replace(/__prefix__/g, formNum)

        const div = document.createElement('div')
        div.innerHTML = newFormHTML
        formList.appendChild(div.firstElementChild)

        totalFormsInput.value = formNum + 1
      })
    }

    // ----------------------------------------
    // [ORIGINAL] Lógica de remover formset
    // ----------------------------------------
    function setupRemoveFormButtons(listId, formRowClass) {
      const formList = document.getElementById(listId)
      if (!formList) return

      formList.addEventListener('click', function (event) {
        if (event.target.classList.contains('remove-form-btn')) {
          const formRow = event.target.closest(`.${formRowClass}`)
          if (formRow) {
            const deleteCheckbox = formRow.querySelector('input[type="checkbox"][name*="DELETE"]')
            if (deleteCheckbox) {
              // Marca para deleção e oculta o formulário existente
              deleteCheckbox.checked = true
              formRow.style.display = 'none'
            } else {
              // Apenas remove o formulário novo (que ainda não foi salvo) do DOM
              formRow.remove()
              // Nota: Se remover um formulário novo, o TOTAL_FORMS não é decrementado
              // Isso é o comportamento padrão do Django e é gerenciado pelo formset.
            }
          }
        }
      })
    }

    // Inicializa a funcionalidade para os formsets (fluxo de adicionar fornecedor removido)
    setupAddFormButton('add-variation-form', 'variation-form-list', 'empty-variation-form', 'variations')

    // Inicializa os botões de remover para ambos os formsets
    setupRemoveFormButtons('supplier-form-list', 'supplier-form-item')
    setupRemoveFormButtons('variation-form-list', 'variation-form')

    // ----------------------------------------
    // [ORIGINAL] Lógica do Modal de Categoria
    // ----------------------------------------
    const categoryModal = document.getElementById('category-modal')
    const addCategoryBtn = document.getElementById('add-category-btn')
    const cancelCategoryBtn = document.getElementById('cancel-category-btn')
    const categoryModalForm = document.getElementById('category-modal-form')
    const categoryNameInput = document.getElementById('id_new_category_name')
    const categoryModalError = document.getElementById('category-modal-error')

    // Usar API do Bootstrap para exibir/ocultar modais
    let bsCategoryModal = null
    if (categoryModal && typeof bootstrap !== 'undefined') {
      bsCategoryModal = new bootstrap.Modal(categoryModal)
    }

    if (addCategoryBtn) {
      addCategoryBtn.addEventListener('click', () => {
        if (bsCategoryModal) {
          bsCategoryModal.show()
        }
        categoryNameInput.value = '' // Limpa o campo
        categoryModalError.classList.add('d-none') // Oculta erros (bootstrap)
        categoryNameInput.focus()
      })
    }

    if (cancelCategoryBtn) {
      cancelCategoryBtn.addEventListener('click', () => {
        if (bsCategoryModal) {
          bsCategoryModal.hide()
        }
      })
    }

    if (categoryModalForm) {
      categoryModalForm.addEventListener('submit', function (e) {
        e.preventDefault()
        const categoryName = categoryNameInput.value

        fetch("{% url 'product:category-create' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({ name: categoryName })
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === 'success') {
              // 1. Cria a nova <option>
              // (valor, texto, selecionado por padrão, selecionado agora)
              const newOption = new Option(data.name, data.id, true, true)

              // 2. Adiciona ao <select> principal e o seleciona
              const mainCategorySelect = document.getElementById('{{ product_form.category.id_for_label }}')
              mainCategorySelect.appendChild(newOption)
              mainCategorySelect.value = data.id // Garante que está selecionado

              // 3. Fecha o modal
              if (bsCategoryModal) bsCategoryModal.hide()
            } else {
              // Mostra o erro no modal
              categoryModalError.textContent = data.message
              categoryModalError.classList.remove('d-none')
            }
          })
          .catch((error) => {
            console.error('Erro no AJAX:', error)
            categoryModalError.textContent = 'Erro de conexão. Tente novamente.'
            categoryModalError.classList.remove('d-none')
          })
      })
    }

    // garante referência ao formulário principal para delegação de eventos
    const mainForm = document.getElementById('product-form')

    // ----------------------------------------
    // Lógica do Modal de Fornecedor (reativada)
    // ----------------------------------------
    const supplierModal = document.getElementById('supplier-modal')
    const cancelSupplierBtn = document.getElementById('cancel-supplier-btn')
    const supplierModalForm = document.getElementById('supplier-modal-form')
    const supplierNameInput = document.getElementById('id_new_supplier_name')
    const supplierModalError = document.getElementById('supplier-modal-error')

    // Guarda qual <select> de fornecedor ativou o modal
    let activeSupplierSelect = null

    // Inicializa o modal via API do Bootstrap
    let bsSupplierModal = null
    if (supplierModal && typeof bootstrap !== 'undefined') {
      bsSupplierModal = new bootstrap.Modal(supplierModal)
    }

    // Delegação de evento: botões '.add-supplier-btn' (podem ser criados dinamicamente)
    if (mainForm) {
      mainForm.addEventListener('click', function (event) {
        const addSupplierBtn = event.target.closest && event.target.closest('.add-supplier-btn')
        if (addSupplierBtn) {
          // Encontrar o <select> mais próximo do botão
          let container = addSupplierBtn.closest('.d-flex') || addSupplierBtn.parentElement
          let sel = null
          if (container) sel = container.querySelector('select')
          let up = addSupplierBtn.parentElement
          while (!sel && up) {
            sel = up.querySelector ? up.querySelector('select') : null
            up = up.parentElement
          }
          activeSupplierSelect = sel

          if (bsSupplierModal) bsSupplierModal.show()
          supplierNameInput.value = ''
          supplierModalError.classList.add('d-none')
          supplierNameInput.focus()
        }
      })
    }

    if (cancelSupplierBtn) {
      cancelSupplierBtn.addEventListener('click', () => {
        if (bsSupplierModal) bsSupplierModal.hide()
        activeSupplierSelect = null
      })
    }

    if (supplierModalForm) {
      supplierModalForm.addEventListener('submit', function (e) {
        e.preventDefault()
        const supplierName = supplierNameInput.value

        fetch("{% url 'product:supplier-create' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({ name: supplierName })
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === 'success') {
              // encontra todos os selects de fornecedor e adiciona a nova option
              const allSupplierSelects = document.querySelectorAll('select[name*="-supplier"]')
              allSupplierSelects.forEach((select) => {
                const newOption = new Option(data.name, data.id)
                select.appendChild(newOption)
              })

              // seleciona apenas o select que abriu o modal
              if (activeSupplierSelect) {
                activeSupplierSelect.value = data.id
              }

              if (bsSupplierModal) bsSupplierModal.hide()
            } else {
              supplierModalError.textContent = data.message
              supplierModalError.classList.remove('d-none')
            }
          })
          .catch((error) => {
            console.error('Erro no AJAX:', error)
            supplierModalError.textContent = 'Erro de conexão. Tente novamente.'
            supplierModalError.classList.remove('d-none')
          })
      })
    }

    // ----------------------------------------
    // [ORIGINAL] Lógica do Modal de Cor
    // ----------------------------------------
    const colorModal = document.getElementById('color-modal')
    const cancelColorBtn = document.getElementById('cancel-color-btn')
    const colorModalForm = document.getElementById('color-modal-form')
    const colorNameInput = document.getElementById('id_new_color_name')
    const colorModalError = document.getElementById('color-modal-error')
    let activeColorSelect = null // Guarda qual <select> de cor ativou o modal

    // Delegação de evento para .add-color-btn
    if (mainForm) {
      mainForm.addEventListener('click', function (event) {
        const addColorBtn = event.target.closest && event.target.closest('.add-color-btn')
        if (addColorBtn) {
          let container = addColorBtn.closest('.d-flex') || addColorBtn.parentElement
          let sel = null
          if (container) sel = container.querySelector('select')
          let up = addColorBtn.parentElement
          while (!sel && up) {
            sel = up.querySelector ? up.querySelector('select') : null
            up = up.parentElement
          }
          activeColorSelect = sel

          if (bsColorModal) bsColorModal.show()
          colorNameInput.value = ''
          colorModalError.classList.add('d-none')
          colorNameInput.focus()
        }
      })
    }

    let bsColorModal = null
    if (colorModal && typeof bootstrap !== 'undefined') {
      bsColorModal = new bootstrap.Modal(colorModal)
    }

    if (cancelColorBtn) {
      cancelColorBtn.addEventListener('click', () => {
        if (bsColorModal) bsColorModal.hide()
        activeColorSelect = null // Limpa a referência
      })
    }

    if (colorModalForm) {
      colorModalForm.addEventListener('submit', function (e) {
        e.preventDefault()
        const colorName = colorNameInput.value

        fetch("{% url 'product:color-create' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({ name: colorName })
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === 'success') {
              // 1. Encontra TODOS os selects de cor
              const allColorSelects = document.querySelectorAll('select[name*="-color"]')

              // 2. Adiciona a nova opção a cada um deles
              allColorSelects.forEach((select) => {
                const newOption = new Option(data.name, data.id)
                select.appendChild(newOption)
              })

              // 3. Seleciona o novo valor APENAS no <select> que abriu o modal
              if (activeColorSelect) {
                activeColorSelect.value = data.id
              }

              // 4. Fecha o modal
              if (bsColorModal) bsColorModal.hide()
            } else {
              colorModalError.textContent = data.message
              colorModalError.classList.remove('d-none')
            }
          })
          .catch((error) => {
            console.error('Erro no AJAX:', error)
            colorModalError.textContent = 'Erro de conexão. Tente novamente.'
            colorModalError.classList.remove('d-none')
          })
      })
    }

    // ----------------------------------------
    // [ORIGINAL] Lógica do Modal de Tamanho
    // ----------------------------------------
    const sizeModal = document.getElementById('size-modal')
    const cancelSizeBtn = document.getElementById('cancel-size-btn')
    const sizeModalForm = document.getElementById('size-modal-form')
    const sizeNameInput = document.getElementById('id_new_size_name')
    const sizeModalError = document.getElementById('size-modal-error')
    let activeSizeSelect = null // Guarda qual <select> de tamanho ativou o modal

    // Delegação de evento para .add-size-btn
    if (mainForm) {
      mainForm.addEventListener('click', function (event) {
        const addSizeBtn = event.target.closest && event.target.closest('.add-size-btn')
        if (addSizeBtn) {
          let container = addSizeBtn.closest('.d-flex') || addSizeBtn.parentElement
          let sel = null
          if (container) sel = container.querySelector('select')
          let up = addSizeBtn.parentElement
          while (!sel && up) {
            sel = up.querySelector ? up.querySelector('select') : null
            up = up.parentElement
          }
          activeSizeSelect = sel

          if (bsSizeModal) bsSizeModal.show()
          sizeNameInput.value = ''
          sizeModalError.classList.add('d-none')
          sizeNameInput.focus()
        }
      })
    }

    let bsSizeModal = null
    if (sizeModal && typeof bootstrap !== 'undefined') {
      bsSizeModal = new bootstrap.Modal(sizeModal)
    }

    if (cancelSizeBtn) {
      cancelSizeBtn.addEventListener('click', () => {
        if (bsSizeModal) bsSizeModal.hide()
        activeSizeSelect = null // Limpa a referência
      })
    }

    if (sizeModalForm) {
      sizeModalForm.addEventListener('submit', function (e) {
        e.preventDefault()
        const sizeName = sizeNameInput.value

        fetch("{% url 'product:size-create' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({ name: sizeName })
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === 'success') {
              // 1. Encontra TODOS os selects de tamanho
              const allSizeSelects = document.querySelectorAll('select[name*="-size"]')

              // 2. Adiciona a nova opção a cada um deles
              allSizeSelects.forEach((select) => {
                const newOption = new Option(data.name, data.id)
                select.appendChild(newOption)
              })

              // 3. Seleciona o novo valor APENAS no <select> que abriu o modal
              if (activeSizeSelect) {
                activeSizeSelect.value = data.id
              }

              // 4. Fecha o modal
              if (bsSizeModal) bsSizeModal.hide()
            } else {
              sizeModalError.textContent = data.message
              sizeModalError.classList.remove('d-none')
            }
          })
          .catch((error) => {
            console.error('Erro no AJAX:', error)
            sizeModalError.textContent = 'Erro de conexão. Tente novamente.'
            sizeModalError.classList.remove('d-none')
          })
      })
    }
  })
</script>
{% endblock %}