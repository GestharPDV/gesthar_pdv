{% extends 'base/base.html' %}
{% load static %}

{% block content %}
<div class="pr-20 pl-20">
  
  <h1 class="titulo">{{ action|upper }} USUÁRIO</h1>

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if form.non_field_errors %}
  <div class="alert alert-danger alert-dismissible fade show mt-3 shadow-sm" role="alert">
    <strong>Ocorreram erros ao salvar:</strong>
    <ul class="mb-0 mt-2">
      {% for error in form.non_field_errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endif %}

  <form method="post" class="space-y-6">
    {% csrf_token %}

    <!-- Card Dados Pessoais -->
    <div class="card border-light mb-4 shadow-sm">
      <h2 class="subtitulo">Dados Pessoais</h2>
      <div class="card-body">

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.first_name.id_for_label }}" class="form-label text-muted fw-bold small">
                NOME <span class="text-danger">*</span>
            </label>
            {{ form.first_name }}
            {% for error in form.first_name.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ form.last_name.id_for_label }}" class="form-label text-muted fw-bold small">
                SOBRENOME <span class="text-danger">*</span>
            </label>
            {{ form.last_name }}
            {% for error in form.last_name.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.email.id_for_label }}" class="form-label text-muted fw-bold small">
                EMAIL <span class="text-danger">*</span>
            </label>
            {{ form.email }}
            {% for error in form.email.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ form.cpf.id_for_label }}" class="form-label text-muted fw-bold small">
                CPF <span class="text-danger">*</span>
            </label>
            {{ form.cpf }}
            {% for error in form.cpf.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.phone_number.id_for_label }}" class="form-label text-muted fw-bold small">TELEFONE</label>
            {{ form.phone_number }}
            {% for error in form.phone_number.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ form.birth_date.id_for_label }}" class="form-label text-muted fw-bold small">DATA DE NASCIMENTO</label>
            {{ form.birth_date }}
            {% for error in form.birth_date.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Card Senha (apenas na criação) -->
    {% if not form.instance.pk %}
    <div class="card border-light mb-4 shadow-sm">
      <h2 class="subtitulo">Senha de Acesso</h2>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.password1.id_for_label }}" class="form-label text-muted fw-bold small">
              SENHA <span class="text-danger">*</span>
            </label>
            {{ form.password1 }}
            <small class="form-text text-muted">Mínimo 8 caracteres</small>
            {% for error in form.password1.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ form.password2.id_for_label }}" class="form-label text-muted fw-bold small">
              CONFIRMAR SENHA <span class="text-danger">*</span>
            </label>
            {{ form.password2 }}
            {% for error in form.password2.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Card Dados Profissionais -->
    <div class="card border-light mb-4 shadow-sm">
      <h2 class="subtitulo">Dados Profissionais</h2>
      <div class="card-body">
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.role.id_for_label }}" class="form-label text-muted fw-bold small">CARGO/FUNÇÃO</label>
            {{ form.role }}
            {% for error in form.role.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
          
          <div class="col-md-6 mb-3 d-flex align-items-center pt-4">
            {% if 'is_active' in form.fields %}
            <div class="form-check">
              {{ form.is_active }}
              <label class="form-check-label fw-bold text-muted" for="{{ form.is_active.id_for_label }}">USUÁRIO ATIVO</label>
            </div>
            {% endif %}
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.hire_date.id_for_label }}" class="form-label text-muted fw-bold small">DATA DE ADMISSÃO</label>
            {{ form.hire_date }}
            {% for error in form.hire_date.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
          {% if 'exit_date' in form.fields %}
          <div class="col-md-6 mb-3">
            <label for="{{ form.exit_date.id_for_label }}" class="form-label text-muted fw-bold small">DATA DE SAÍDA</label>
            {{ form.exit_date }}
            {% for error in form.exit_date.errors %}
            <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <div class="mb-3">
          <label for="{{ form.notes.id_for_label }}" class="form-label text-muted fw-bold small">OBSERVAÇÕES</label>
          {{ form.notes }}
          {% for error in form.notes.errors %}
          <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

      </div>
    </div>

    <!-- Botões de Ação -->
    <div class="mt-4 d-flex gap-3">
      <button type="submit" class="botao-rosa p-3 px-5 fw-bold text-uppercase shadow-sm">
        SALVAR
      </button>
      
      <a href="{% url 'user:user-list' %}" class="botao-vermelho p-3 px-5 fw-bold text-uppercase shadow-sm text-decoration-none">
        CANCELAR
      </a>
    </div>

  </form>
</div>

<!-- Scripts de Máscara (Formatação enquanto digita) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- MÁSCARA CPF ---
    const cpfInput = document.getElementById('{{ form.cpf.id_for_label }}');
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove tudo que não é número
            if (value.length > 11) value = value.slice(0, 11); // Limita a 11 números

            // Aplica a máscara 000.000.000-00
            if (value.length > 9) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2}).*/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3}).*/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/^(\d{3})(\d{3}).*/, '$1.$2');
            }
            
            e.target.value = value;
        });
    }

    // --- MÁSCARA TELEFONE ---
    const phoneInput = document.getElementById('{{ form.phone_number.id_for_label }}');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);

            // Aplica máscara (XX) XXXXX-XXXX
            if (value.length > 10) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d{0,5}).*/, '($1) $2');
            } else if (value.length > 0) {
                value = value.replace(/^(\d*)/, '($1');
            }
            e.target.value = value;
        });
    }

});
</script>
{% endblock %}