{% extends 'global/base.html' %}
{% load static %}

{% block content %}
<div class="pr-20 pl-20">
    
    <!-- Título -->
    <div class="mb-4">
        <h1 class="titulo">VISUALIZAR USUÁRIOS</h1>
    </div>

    <!-- Barra de Pesquisa -->
    <form method="GET" action="{% url 'user:user-list' %}" class="mb-3 d-flex justify-content-end align-items-center gap-2">
        <label for="search_right" class="fw-bold text-uppercase" style="font-size: 0.8rem; color: var(--cor-fonte-cinza);">
            PESQUISAR
        </label>
        
        <div class="position-relative w-100" style="max-width:300px;">
            <input id="search_right" type="text" name="query" value="{{ query }}"
                class="form-control rounded-pill bg-transparent pe-5" 
                style="color: var(--cor-fonte-preta); border-color: #ced4da;"
                placeholder="Nome, CPF ou Email...">
                
            <!-- Botão de Lupa (Submit) -->
            <button type="submit" aria-label="Pesquisar" style="color: var(--cor-fonte-cinza) !important;"
                class="position-absolute end-0 top-50 translate-middle-y border-0 bg-transparent p-0 pe-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                    class="h-5 w-5" width="20" height="20" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M21 21l-4.35-4.35M11 18.5a7.5 7.5 0 100-15 7.5 7.5 0 000 15z" />
                </svg>
            </button>
        </div>

        <!-- BOTÃO LIMPAR (Só aparece se houver busca) -->
        {% if query %}
        <a href="{% url 'user:user-list' %}" class="btn btn-outline-danger rounded-circle d-flex align-items-center justify-content-center shadow-sm" 
           style="width: 30px; height: 30px; padding: 0;" title="Limpar Filtro">
            <span style="font-size: 1.2rem; line-height: 1;">&times;</span>
        </a>
        {% endif %}
    </form>

    <!-- Tabela -->
    <div class="rounded-4 shadow-sm border border-light overflow-hidden">
        <table class="table table-bordered align-middle mb-0 text-center product-list">
            <thead>
                <tr class="cabecalho text-uppercase">
                    <th style="width: 50px;">#</th>
                    <th>VISUALIZAR</th>
                    <th>ID</th>
                    <th>STATUS</th>
                    <th>NOME</th>
                    <th>IDADE</th>
                    <th>CARGO/FUNÇÃO</th>
                    <th>TELEFONE</th>
                    <th>ADMISSÃO</th>
                    <th>SAÍDA</th>
                </tr>
            </thead>

            <tbody>
                {% for user in users %}
                <tr class="align-middle" style="cursor:default;" onclick="selectRow(this, '{{ user.id }}')">
                    <!-- Seleção (Radio) -->
                    <td>
                        <input type="radio" name="selected_user" value="{{ user.id }}" class="form-check-input mt-0" id="user_radio_{{ user.id }}">
                    </td>

                    <!-- Visualizar -->
                    <td class="d-flex justify-content-center align-items-center">
                        <a href="{% url 'user:user-profile' user.id %}" class="d-inline-flex" style="color: var(--cor-fonte-preta);" title="Visualizar Detalhes" onclick="event.stopPropagation();">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                                <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                            </svg>
                        </a>
                    </td>

                    <!-- ID -->
                    <td>{{ user.id|stringformat:"03d" }}</td>

                    <!-- Status -->
                    <td class="fw-bold text-uppercase" style="font-size: 0.85rem;">
                        {% if user.is_active %}
                        <span>ATIVO</span>
                        {% else %}
                        <span>INATIVO</span>
                        {% endif %}
                    </td>

                    <!-- Nome -->
                    <td class="text-start text-uppercase fw-bold">{{ user.first_name }} {{ user.last_name }}</td>

                    <!-- Idade -->
                    <td>
                        {% if user.birth_date %}
                            {{ user.birth_date|timesince|slice:":2" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>

                    <!-- Cargo -->
                    <td class="text-uppercase">{{ user.role|default:"-" }}</td>

                    <!-- Telefone Formatado -->
                    <td>
                        {% if user.phone_number %}
                            {% if user.phone_number|length == 11 %}
                                ({{ user.phone_number|slice:":2" }}) {{ user.phone_number|slice:"2:7" }}-{{ user.phone_number|slice:"7:" }}
                            {% elif user.phone_number|length == 10 %}
                                ({{ user.phone_number|slice:":2" }}) {{ user.phone_number|slice:"2:6" }}-{{ user.phone_number|slice:"6:" }}
                            {% else %}
                                {{ user.phone_number }}
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>

                    <!-- Admissão -->
                    <td>{{ user.hire_date|date:"d/m/Y"|default:"-" }}</td>

                    <!-- Saída -->
                    <td>{{ user.exit_date|date:"d/m/Y"|default:"" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center py-4" style="color: var(--cor-fonte-cinza);">
                        {% if query %}
                            Nenhum usuário encontrado para "{{ query }}".<br>
                            <a href="{% url 'user:user-list' %}" class="text-decoration-none fw-bold mt-2 d-inline-block" style="color: var(--cor-fonte-rosa);">Limpar pesquisa</a>
                        {% else %}
                            Nenhum usuário cadastrado.
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Botões de Ação Inferiores -->
    <div class="d-flex justify-content-start mt-4 gap-3">
        <button type="button" class="botao-amarelo p-2 px-4 fw-bold text-uppercase shadow-sm" style="color: #555;" onclick="handleAction('edit')">
            Editar Usuário
        </button>
        
        <button type="button" class="botao-vermelho p-2 px-4 fw-bold text-uppercase shadow-sm" onclick="handleAction('delete')">
            Excluir Usuário
        </button>
    </div>

</div>

<script>
    function selectRow(row, userId) {
        const radio = document.getElementById('user_radio_' + userId);
        if(radio) radio.checked = true;
    }

    function handleAction(action) {
        const selected = document.querySelector('input[name="selected_user"]:checked');
        
        if (!selected) {
            alert('Por favor, selecione um usuário na tabela primeiro.');
            return;
        }
        
        const userId = selected.value;
        
        if (action === 'edit') {
            window.location.href = "/user/profile/edit/" + userId + "/";
        } else if (action === 'delete') {
            window.location.href = "/user/" + userId + "/delete/";
        }
    }
</script>
{% endblock %}